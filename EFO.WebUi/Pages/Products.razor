@page "/products"
@using System.Text.Json
@using EFO.WebUi.Data
@inject IProductService ProductService
@inject IOrderService OrderService

<PageTitle>Catalog</PageTitle>

<h1>Select Category</h1>


@if (_products == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <div class="container-fluid">
        <div class="row bg-dark text-light">
            <div class="col col-6 border-end py-2">Product</div>
            <div class="col col-2 border-end py-2">Price per Quantity</div>
            <div class="col col-2 border-end py-2">Quantity</div>
            <div class="col col-2 py-2"></div>
        </div>
        @for (var pIx = 0; pIx < _products.Length; ++pIx)
        {
            var productIndex = pIx;
            var product = _products[pIx];

            <div class="row border-bottom border" style="min-height: 150px">
                <div class="col col-6 py-3 fw-bold">@product.Name</div>
                <div class="col col-2 py-3">
                    <table class="table table-sm p-0 m-0 text-end w-auto">
                        <thead>
                        <tr>
                            <th class="border-0 fw-light p-0 px-3 m-0">
                                <small>Quantity:</small>
                            </th>
                            <th class="border-0 fw-light p-0 px-3 m-0">
                                <small>Net Unit Price:</small>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var price in product.Prices)
                        {
                            <tr>
                                <td class="border-0 py-0 my-0 px-3">
                                    <small>@price.QuantityThreshold+</small>
                                </td>
                                <td class="border-0 py-0 my-0 px-3 fw-bold">
                                    <small>@price.UnitPrice.ToString("N2")</small>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
                <div class="col col-2 py-3">
                    <div class="row h-25">
                        <div class="col text-center">
                            Minimum quantity: @product.Prices[0].QuantityThreshold
                        </div>
                    </div>
                    <div class="row h-50">
                        <div class="col align-self-center d-flex justify-content-center">
                            <input type="text" class="form-control w-50" @bind-value="@_quantities![productIndex]"/>
                        </div>
                    </div>
                    <div class="row h-25"></div>
                </div>
                <div class="col col-2 align-self-center text-center py-3">
                    <button type="button" class="btn btn-primary" @onclick="async args => { await OrderService.AddOrderItemAsync(new AddOrderItemDto(product.ProductId, _quantities![productIndex])); }">Add to order</button>
                </div>
            </div>
        }
    </div>
}

@*<button class="btn btn-primary" @onclick="StartOrderAsync">Click me</button>*@

@code
{
    private int[]? _quantities;

    private ProductDto[]? _products;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        var products = await ProductService.GetProductsAsync();
        _products = products;
        _quantities = new int[_products.Length];
    }


}